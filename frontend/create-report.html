<!DOCTYPE html>
<html>
<head>
    <title>Create Report (Secure)</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">

    <h2>Create Expense Report (Secure)</h2>
    <p style="color:red;font-weight:bold;">SECURE CREATE ACTIVE â€” NO INNERHTML</p>

    <input id="title" placeholder="Report title" />

    <h3>Add items</h3>
    <div id="items"></div>

    <button onclick="addItem()">Add Item</button><br><br>
    <button onclick="submitReport()">Submit Report</button>

    <p id="msg"></p>
</div>

<script>
    function addItem() {
        const box = document.createElement("div");
        box.className = "item-box";

        // category
        const cat = document.createElement("input");
        cat.placeholder = "Category";
        cat.className = "cat";

        // description
        const desc = document.createElement("input");
        desc.placeholder = "Description";
        desc.className = "desc";

        // amount
        const amt = document.createElement("input");
        amt.placeholder = "Amount";
        amt.type = "number";
        amt.className = "amt";

        box.appendChild(cat);
        box.appendChild(desc);
        box.appendChild(amt);

        document.getElementById("items").appendChild(box);
    }

    function submitReport() {
        const userId = localStorage.getItem("userId");
        if (!userId) return alert("Not logged in");

        const title = document.getElementById("title").value;
        const itemsDivs = document.querySelectorAll(".item-box");

        const items = [];
        itemsDivs.forEach(div => {
            items.push({
                category: div.querySelector(".cat").value,
                description: div.querySelector(".desc").value,
                amount: Number(div.querySelector(".amt").value)
            });
        });

        fetch(`http://localhost:8080/reports/create/${userId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title, items })
        })
            .then(r => r.json())
            .then(data => {
                if (data.id) {
                    localStorage.setItem("lastReportId", data.id);
                    window.location = "view-report.html";
                } else {
                    const msg = document.getElementById("msg");
                    msg.textContent = "Error creating report"; // SAFE
                }
            });
    }
</script>

</body>
</html>
